---
import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';
import { blogPosts, getCategories } from '../data/blog-posts';

// Show all posts including drafts on localhost
const publishedPosts = blogPosts;
const categories = getCategories();
---

<Layout title="Blog" description="Health insights, research updates, and expert advice from our medical team. Stay informed about the latest in telehealth and lifestyle medicine.">
  <Navigation />
  
  <!-- Hero Section -->
  <section class="bg-gradient-primary section-padding">
    <div class="container-max text-center">
      <h1 class="text-4xl lg:text-6xl font-bold text-neutral-900 mb-6">
        Health Insights & Research
      </h1>
      <p class="text-xl lg:text-2xl text-neutral-600 max-w-4xl mx-auto leading-relaxed">
        Expert medical insights, research updates, and practical health advice from our qualified doctors
      </p>
    </div>
  </section>

  <!-- Category Filter -->
  <section class="section-padding bg-white border-b border-neutral-200">
    <div class="container-max">
      <div class="flex flex-wrap justify-center gap-4">
        {categories.map((category) => (
          <button 
            class="category-filter px-6 py-3 rounded-full border-2 border-neutral-300 text-neutral-600 hover:border-primary-500 hover:text-primary-600 transition-colors duration-200"
            data-category={category === 'All' ? 'all' : category.toLowerCase().replace(/\s+/g, '-')}
          >
            {category}
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- Blog Posts with Sidebar -->
  <section class="section-padding bg-white">
    <div class="container-max">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- Main Blog Content -->
        <div class="lg:col-span-3">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8" id="blog-grid">
            {publishedPosts.map((post) => (
              <article class="card h-full flex flex-col group" data-category={post.category.toLowerCase().replace(/\s+/g, '-')}>
                <div class="bg-gradient-to-br from-neutral-100 to-neutral-200 rounded-lg h-48 mb-6 flex items-center justify-center overflow-hidden">
                  <picture>
                    <source 
                      srcset={post.image}
                      type="image/webp">
                    <img 
                      src={post.image}
                      alt={`${post.title} - ${post.tags && post.tags.length > 0 ? post.tags.slice(0, 2).join(', ') + ' guide' : 'weight loss guide'} for New Zealand patients`}
                      title={`${post.title} | Vital Health NZ`}
                      class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
                      loading="lazy"
                      decoding="async"
                      width="400"
                      height="225"
                      onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=text-center><svg class=w-16 h-16 text-neutral-400 mx-auto mb-2 fill=none stroke=currentColor viewBox=0 0 24 24><path stroke-linecap=round stroke-linejoin=round stroke-width=2 d=M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z></path></svg><p class=text-sm text-neutral-500>Blog Image</p></div>'"
                      itemprop="image">
                  </picture>
                </div>
                
                <div class="flex-1">
                  <div class="flex items-center space-x-2 mb-3">
                    <span class="text-sm font-medium text-primary-600">{post.category}</span>
                    <span class="text-neutral-400">•</span>
                    <span class="text-sm text-neutral-500">{post.readTime}</span>
                    {post.draft && (
                      <>
                        <span class="text-neutral-400">•</span>
                        <span class="text-sm font-medium text-amber-600 bg-amber-100 px-2 py-1 rounded-full">Draft</span>
                      </>
                    )}
                  </div>
                  
                  <h3 class="text-xl font-bold text-neutral-900 mb-3 line-clamp-2 group-hover:text-primary-600 transition-colors duration-200">
                    {post.title}
                  </h3>
                  
                  <p class="text-neutral-600 mb-4 line-clamp-3">
                    {post.excerpt}
                  </p>
                  
                  <div class="mt-auto">
                    <div class="text-sm text-neutral-500 mb-3">
                      {new Date(post.date).toLocaleDateString('en-NZ', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                      })}
                    </div>
                    
                    <a href={`/blog/${post.id}`} class="text-primary-600 hover:text-primary-700 font-medium inline-flex items-center group-hover:translate-x-1 transition-transform duration-200">
                      Read More
                      <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                    </a>
                  </div>
                </div>
              </article>
            ))}
          </div>
          
          <!-- Load More Button -->
          <div class="text-center mt-12">
            <button class="btn-secondary text-lg px-8 py-4">
              Load More Articles
            </button>
          </div>
        </div>
        
        <!-- Blog Sidebar -->
        <div class="lg:col-span-1">
          <div class="space-y-8">
            <!-- Search Widget -->
            <div class="card">
              <h3 class="text-lg font-bold text-neutral-900 mb-4">Search Articles</h3>
              <div class="relative">
                <input 
                  type="text" 
                  placeholder="Search health topics..." 
                  class="w-full px-4 py-2 border border-neutral-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                  id="blog-search"
                />
                <svg class="w-5 h-5 text-neutral-400 absolute right-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
              </div>
            </div>
            
            <!-- Recent Posts Widget -->
            <div class="card">
              <h3 class="text-lg font-bold text-neutral-900 mb-4">Recent Posts</h3>
              <div class="space-y-4">
                {publishedPosts.slice(0, 5).map((post) => (
                  <a href={`/blog/${post.id}`} class="group block">
                    <div class="space-y-2">
                      <h4 class="text-sm font-medium text-neutral-900 group-hover:text-primary-600 transition-colors duration-200 line-clamp-2">
                        {post.title}
                      </h4>
                      <p class="text-xs text-neutral-500">
                        {new Date(post.date).toLocaleDateString('en-NZ', { 
                          month: 'short', 
                          day: 'numeric' 
                        })}
                      </p>
                    </div>
                  </a>
                ))}
              </div>
            </div>
            
            <!-- Categories Widget -->
            <div class="card">
              <h3 class="text-lg font-bold text-neutral-900 mb-4">Categories</h3>
              <div class="space-y-2">
                {categories.filter(cat => cat !== 'All').map((category) => (
                  <a 
                    href="#" 
                    class="category-filter block text-sm text-neutral-600 hover:text-primary-600 transition-colors duration-200"
                    data-category={category.toLowerCase().replace(/\s+/g, '-')}
                  >
                    {category}
                  </a>
                ))}
              </div>
            </div>
            
            <!-- Newsletter Signup -->
            <div class="card bg-primary-50 border-primary-200">
              <h3 class="text-lg font-bold text-primary-900 mb-2">Stay Updated</h3>
              <p class="text-sm text-primary-700 mb-4">Get the latest health insights delivered to your inbox.</p>
              <form class="space-y-3">
                <input 
                  type="email" 
                  placeholder="Enter your email" 
                  class="w-full px-3 py-2 text-sm border border-primary-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                  required
                />
                <button type="submit" class="w-full btn-primary text-sm py-2">
                  Subscribe
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Newsletter Signup -->
  <section class="section-padding bg-primary-600">
    <div class="container-max text-center">
      <h2 class="text-3xl lg:text-4xl font-bold text-white mb-4">
        Stay Updated
      </h2>
      <p class="text-xl text-primary-100 mb-8 max-w-2xl mx-auto">
        Get the latest health insights and research updates delivered to your inbox.
      </p>
      
      <form class="max-w-md mx-auto flex flex-col sm:flex-row gap-4">
        <input 
          type="email" 
          placeholder="Enter your email" 
          class="flex-1 px-4 py-3 rounded-lg border-0 focus:ring-2 focus:ring-white focus:ring-opacity-50"
          required
        />
        <button type="submit" class="btn-accent whitespace-nowrap">
          Subscribe
        </button>
      </form>
      
      <p class="text-primary-200 text-sm mt-4">
        We respect your privacy. Unsubscribe at any time.
      </p>
    </div>
  </section>

  <Footer />
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
  // Enhanced Blog Functionality
  document.addEventListener('DOMContentLoaded', function() {
    const categoryButtons = document.querySelectorAll('.category-filter');
    const blogGrid = document.getElementById('blog-grid');
    const posts = Array.from(blogGrid?.children || []);
    const searchInput = document.getElementById('blog-search') as HTMLInputElement;
    
    // Category Filter Functionality
    categoryButtons.forEach(button => {
      button.addEventListener('click', function() {
        const buttonElement = button as HTMLButtonElement;
        const category = buttonElement.dataset.category;
        
        // Update active button state
        categoryButtons.forEach(btn => {
          btn.classList.remove('border-primary-500', 'text-primary-600');
          btn.classList.add('border-neutral-300', 'text-neutral-600');
        });
        button.classList.remove('border-neutral-300', 'text-neutral-600');
        button.classList.add('border-primary-500', 'text-primary-600');
        
        // Filter posts
        filterPosts(category || 'all', searchInput?.value || '');
      });
    });
    
    // Search Functionality
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const activeCategory = getActiveCategory();
        filterPosts(activeCategory, searchTerm);
      });
    }
    
    // Combined filter function
    function filterPosts(category: string, searchTerm: string) {
      posts.forEach(post => {
        const postElement = post as HTMLElement;
        const postCategory = postElement.dataset.category;
        const postTitle = postElement.querySelector('h3')?.textContent?.toLowerCase() || '';
        const postExcerpt = postElement.querySelector('p')?.textContent?.toLowerCase() || '';
        const postContent = postTitle + ' ' + postExcerpt;
        
        const categoryMatch = category === 'all' || postCategory === category;
        const searchMatch = searchTerm === '' || postContent.includes(searchTerm);
        
        if (categoryMatch && searchMatch) {
          postElement.style.display = 'block';
          postElement.style.opacity = '1';
        } else {
          postElement.style.display = 'none';
          postElement.style.opacity = '0';
        }
      });
      
      // Show/hide "no results" message
      const visiblePosts = posts.filter(post => (post as HTMLElement).style.display !== 'none');
      showNoResultsMessage(visiblePosts.length === 0);
    }
    
    // Get active category
    function getActiveCategory(): string {
      const activeButton = Array.from(categoryButtons).find(btn => 
        btn.classList.contains('border-primary-500')
      ) as HTMLButtonElement;
      return activeButton?.dataset.category || 'all';
    }
    
    // Show/hide no results message
    function showNoResultsMessage(show: boolean) {
      let noResults = document.getElementById('no-results');
      if (show && !noResults) {
        noResults = document.createElement('div');
        noResults.id = 'no-results';
        noResults.className = 'col-span-full text-center py-12';
        noResults.innerHTML = `
          <div class="text-neutral-500">
            <svg class="w-16 h-16 mx-auto mb-4 text-neutral-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <h3 class="text-xl font-semibold text-neutral-600 mb-2">No articles found</h3>
            <p class="text-neutral-500">Try adjusting your search or category filter.</p>
          </div>
        `;
        if (blogGrid) {
          blogGrid.appendChild(noResults);
        }
      } else if (!show && noResults) {
        noResults.remove();
      }
    }
    
    // Initialize with "All" category active
    const allButton = Array.from(categoryButtons).find(btn => (btn as HTMLButtonElement).dataset.category === 'all');
    if (allButton) {
      allButton.classList.add('border-primary-500', 'text-primary-600');
    }
  });
</script>
